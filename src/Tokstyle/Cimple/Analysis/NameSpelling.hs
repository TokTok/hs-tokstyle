{-# LANGUAGE OverloadedStrings #-}
module Tokstyle.Cimple.Analysis.NameSpelling (analyse) where

import           Control.Monad.State.Lazy    (State)
import qualified Control.Monad.State.Lazy    as State
import           Data.Text                   (Text)
import qualified Data.Text                   as Text
import           Language.Cimple             (Lexeme (..), Node (..))
import           Language.Cimple.Diagnostics (warn)
import           Language.Cimple.TraverseAst


linter :: FilePath -> AstActions (State [Text]) Text
linter file = defaultActions
    { doNode = \node act -> do
        case node of
            FunctionDecl _ (FunctionPrototype _ lexeme@(L _ _ name) _) _ ->
                checkName lexeme name act
            FunctionDefn _ (FunctionPrototype _ lexeme@(L _ _ name) _) _ ->
                checkName lexeme name act

            _ -> act
    }
  where
    checkName lexeme name act = do
        let components = Text.splitOn "_" name
        case filter (not . flip elem knownWords) components of
            []      -> return ()
            unknown -> warn file lexeme $ Text.pack $ show unknown
        act

analyse :: FilePath -> [Node (Lexeme Text)] -> [Text]
analyse file ast = reverse $ State.execState (traverseAst (linter file) ast) []


knownWords :: [Text]
knownWords = toxcore ++ toxav
  where
    toxcore =
        [ "0"
        , "1"
        , "2"
        , "3"
        , "accept"
        , "accepted"
        , "action"
        , "active"
        , "add"
        , "addable"
        , "added"
        , "addfriend"
        , "addpeer"
        , "addr"
        , "addr4"
        , "addr6"
        , "address"
        , "addto"
        , "after"
        , "all"
        , "alloc"
        , "already"
        , "and"
        , "announce"
        , "any"
        , "array"
        , "assoc"
        , "at"
        , "av"
        , "backup"
        , "beg"
        , "bind"
        , "bit"
        , "bootstrap"
        , "break"
        , "broadcast"
        , "broadcasts"
        , "bs"
        , "buffer"
        , "by"
        , "bytes"
        , "bytes16"
        , "bytes32"
        , "bytes64"
        , "c"
        , "calculate"
        , "callback"
        , "callbacks"
        , "change"
        , "changed"
        , "chat"
        , "chatlist"
        , "check"
        , "checksum"
        , "chunk"
        , "clean"
        , "clear"
        , "client"
        , "clientlist"
        , "close"
        , "Close"
        , "closelist"
        , "closest"
        , "cmp"
        , "commonip"
        , "comp"
        , "compatible"
        , "con"
        , "conf"
        , "conference"
        , "conferences"
        , "confirm"
        , "confirmed"
        , "conn"
        , "connect"
        , "connected"
        , "connection"
        , "Connection"
        , "connections"
        , "connectionstatus"
        , "conns"
        , "control"
        , "cookie"
        , "copy"
        , "core"
        , "correct"
        , "count"
        , "create"
        , "crypt"
        , "crypto"
        , "cryptoconnection"
        , "cryptopacket"
        , "cryptpacket"
        , "current"
        , "custom"
        , "data"
        , "dataremaining"
        , "decrypt"
        , "default"
        , "del"
        , "delete"
        , "delfriend"
        , "delpeer"
        , "derive"
        , "dht"
        , "DHT"
        , "dhtpk"
        , "direct"
        , "disconnect"
        , "disconnected"
        , "discovery"
        , "do"
        , "dualstack"
        , "encrypt"
        , "end"
        , "entries"
        , "entry"
        , "epoll"
        , "equal"
        , "error"
        , "ex"
        , "exists"
        , "family"
        , "fetch"
        , "file"
        , "filecb"
        , "filecontrol"
        , "files"
        , "filesender"
        , "filetransfers"
        , "fill"
        , "filter"
        , "find"
        , "free"
        , "freeipport"
        , "freeze"
        , "friend"
        , "friendcon"
        , "friendconn"
        , "friendconns"
        , "friendlist"
        , "friendmessage"
        , "friendreq"
        , "friendrequest"
        , "friends"
        , "friendslist"
        , "from"
        , "frozen"
        , "function"
        , "g"
        , "generate"
        , "generic"
        , "get"
        , "getaddress"
        , "getcryptconnection"
        , "getfriend"
        , "getfriendcon"
        , "getfriendip"
        , "getipport"
        , "getname"
        , "getnode"
        , "getnodes"
        , "getports"
        , "getself"
        , "global"
        , "good"
        , "group"
        , "groupchat"
        , "groupchats"
        , "groupnumber"
        , "groups"
        , "handle"
        , "handlepacket"
        , "handler"
        , "handshake"
        , "hardening"
        , "hash"
        , "have"
        , "header"
        , "helper"
        , "holes"
        , "host"
        , "host16"
        , "host32"
        , "host64"
        , "htonl"
        , "htons"
        , "http"
        , "id"
        , "in"
        , "incoming"
        , "incorrect"
        , "increment"
        , "index"
        , "inet"
        , "info"
        , "init"
        , "initial"
        , "inner"
        , "instance"
        , "internal"
        , "interval"
        , "introduced"
        , "invite"
        , "ip"
        , "ip4"
        , "ip6"
        , "iplist"
        , "ipport"
        , "IPPTsPng"
        , "ipv4"
        , "ipv6"
        , "is"
        , "isconnected"
        , "isset"
        , "istyping"
        , "iterate"
        , "iteration"
        , "join"
        , "key"
        , "keypair"
        , "keys"
        , "kill"
        , "lan"
        , "LANdiscovery"
        , "last"
        , "leave"
        , "lendian"
        , "lendian16"
        , "length"
        , "level"
        , "list"
        , "listen"
        , "listening"
        , "lists"
        , "load"
        , "local"
        , "lock"
        , "log"
        , "logger"
        , "loglogdata"
        , "loopback"
        , "lossless"
        , "lossy"
        , "m"
        , "mac"
        , "make"
        , "malloc"
        , "max"
        , "memcmp"
        , "memzero"
        , "message"
        , "messenger"
        , "min"
        , "mono"
        , "monotonic"
        , "move"
        , "msi"
        , "mutex"
        , "name"
        , "namechange"
        , "names"
        , "nat"
        , "NAT"
        , "NATping"
        , "nc"
        , "net"
        , "network"
        , "networking"
        , "new"
        , "no"
        , "node"
        , "nodes"
        , "non"
        , "nonblock"
        , "nonce"
        , "nonpriority"
        , "nonused"
        , "norequest"
        , "nosigpipe"
        , "nospam"
        , "not"
        , "note"
        , "notification"
        , "ntoa"
        , "ntohl"
        , "ntohs"
        , "ntop4"
        , "ntop6"
        , "num"
        , "number"
        , "object"
        , "of"
        , "offline"
        , "ok"
        , "old"
        , "on"
        , "onion"
        , "oniondata"
        , "online"
        , "oob"
        , "open"
        , "options"
        , "or"
        , "ours"
        , "out"
        , "pack"
        , "packed"
        , "packet"
        , "packets"
        , "parse"
        , "path"
        , "peer"
        , "peername"
        , "peernumber"
        , "peers"
        , "pending"
        , "per"
        , "ping"
        , "pk"
        , "pktid"
        , "plugin"
        , "plugins"
        , "pointer"
        , "poll"
        , "populate"
        , "port"
        , "ports"
        , "precompute"
        , "priority"
        , "process"
        , "proto"
        , "proxy"
        , "pton4"
        , "pton6"
        , "pubkey"
        , "public"
        , "punch"
        , "purge"
        , "query"
        , "randfriends"
        , "random"
        , "reached"
        , "read"
        , "real"
        , "realloc"
        , "reason"
        , "receipt"
        , "receipts"
        , "received"
        , "receivedlist"
        , "receivepacket"
        , "reconnect"
        , "recursive"
        , "recv"
        , "register"
        , "registerhandler"
        , "reject"
        , "rejoin"
        , "relay"
        , "relays"
        , "remove"
        , "replace"
        , "req"
        , "reqchunk"
        , "request"
        , "requested"
        , "requests"
        , "res"
        , "reset"
        , "resize"
        , "resolve"
        , "response"
        , "return"
        , "returnedip"
        , "reuseaddr"
        , "rm"
        , "route"
        , "routeone"
        , "routing"
        , "rtp"
        , "run"
        , "s16"
        , "s32"
        , "s64"
        , "save"
        , "saved"
        , "savedata"
        , "secret"
        , "section"
        , "secure"
        , "seek"
        , "self"
        , "send"
        , "sendback"
        , "sendname"
        , "sendnode"
        , "sendnodes"
        , "sendpacket"
        , "sendqueue"
        , "sendrequest"
        , "sent"
        , "server"
        , "set"
        , "setfriendname"
        , "setname"
        , "setnick"
        , "settitle"
        , "setup"
        , "sha256"
        , "sha512"
        , "shared"
        , "shutdown"
        , "size"
        , "sleep"
        , "slot"
        , "slots"
        , "sock"
        , "socket"
        , "socks5"
        , "socktype"
        , "somewhat"
        , "sort"
        , "source"
        , "speed"
        , "squash"
        , "startup"
        , "state"
        , "status"
        , "statusmessage"
        , "stderr"
        , "store"
        , "strerror"
        , "string"
        , "symmetric"
        , "tcp"
        , "TCP"
        , "temp"
        , "time"
        , "timed"
        , "timedout"
        , "timeout"
        , "timeouts"
        , "title"
        , "to"
        , "tofriend"
        , "tox"
        , "transfer"
        , "trim"
        , "try"
        , "type"
        , "typing"
        , "typingchange"
        , "u08"
        , "u16"
        , "u32"
        , "u64"
        , "udp"
        , "uid"
        , "uint"
        , "uint16"
        , "unconfirmed"
        , "unlock"
        , "unpack"
        , "unsleep"
        , "unspec"
        , "until"
        , "update"
        , "used"
        , "user"
        , "userstatus"
        , "usertyping"
        , "uses"
        , "v6"
        , "valid"
        , "value"
        , "version"
        , "wipe"
        , "with"
        , "write"
        ]
    toxav =
        [ "ac"
        , "allow"
        , "answer"
        , "audio"
        , "bwc"
        , "call"
        , "capabilites"
        , "capabilities"
        , "cfg"
        , "codec"
        , "decode"
        , "decoder"
        , "dequeue"
        , "disable"
        , "empty"
        , "enable"
        , "enabled"
        , "encoder"
        , "frame"
        , "frames"
        , "full"
        , "hangup"
        , "interface"
        , "into"
        , "invalid"
        , "invoke"
        , "jbuf"
        , "lost"
        , "msg"
        , "pop"
        , "prepare"
        , "push"
        , "queue"
        , "rate"
        , "rb"
        , "receive"
        , "receiving"
        , "reconfigure"
        , "recreate"
        , "start"
        , "stop"
        , "terminate"
        , "toxav"
        , "transmission"
        , "values"
        , "vc"
        , "video"
        ]
